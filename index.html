<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°é›»ææ–™ç®¡ç†ç³»çµ± - å®Œæ•´åŠŸèƒ½ç‰ˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --ukiyo-deep-blue: #1D3B56;
      --ukiyo-mid-blue: #2A587A;
      --ukiyo-sky: #E6D3A3;
      --danger-red: #d64545;
      --glass-bg: rgba(255, 255, 255, 0.95);
    }
    
    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0;
      background-color: var(--ukiyo-sky);
      min-height: 100vh;
    }

    /* èƒŒæ™¯èˆ‡ç‰ˆé¢ */
    .ukiyo-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; background: radial-gradient(circle at 50% 30%, #f7f0e6, var(--ukiyo-sky)); }
    .content-wrapper { position: relative; z-index: 10; padding: 20px; max-width: 1000px; margin: 0 auto; }

    header { 
      background: var(--ukiyo-deep-blue); color: white; border-radius: 12px; padding: 20px; text-align: center; 
      box-shadow: 0 10px 25px rgba(29, 59, 86, 0.3); border: 2px solid #D4AF37; margin-bottom: 25px;
    }

    .container-3d { 
      background: var(--glass-bg); border-radius: 20px; padding: 25px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 25px;
    }

    h3.section-title { color: var(--ukiyo-deep-blue); border-left: 6px solid var(--danger-red); padding-left: 15px; margin-bottom: 20px; font-weight: 900; }

    /* è¡¨å–®èˆ‡è¼¸å…¥ */
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    label { display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; color: #444; }
    input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }

    /* ç‰©æ–™é¸æ“‡å™¨ */
    #materialsContainer { 
      display: flex; flex-direction: column; gap: 5px; max-height: 200px; overflow-y: auto; 
      padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; margin-top: 10px;
    }
    .material-btn { padding: 10px; background: #f8f9fa; border: 1px solid #eee; cursor: pointer; border-radius: 6px; text-align: left; }
    .material-btn.active { background: var(--ukiyo-mid-blue); color: white; }

    /* æœå°‹èˆ‡æŸ¥è©¢å€å¡Š */
    .search-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .query-box { background: #f0f4f7; padding: 15px; border-radius: 12px; border: 1px solid #e0e6ed; }

    /* åˆ—è¡¨èˆ‡æŒ‰éˆ• */
    .record-li { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--ukiyo-mid-blue); position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .btn-delete { position: absolute; right: 15px; top: 15px; background: none; border: none; color: #bbb; cursor: pointer; font-size: 1.2rem; }
    .btn-delete:hover { color: var(--danger-red); }
    
    .btn-primary { background: linear-gradient(45deg, var(--ukiyo-deep-blue), var(--ukiyo-mid-blue)); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
    .btn-outline { background: white; border: 1px solid var(--ukiyo-mid-blue); color: var(--ukiyo-mid-blue); padding: 8px; border-radius: 6px; cursor: pointer; margin-top: 5px; width: 100%; }
  </style>
</head>
<body>

  <div class="ukiyo-scene"></div>

  <div class="content-wrapper">
    <header><h2>å°é›»ææ–™ç®¡ç†ç³»çµ±</h2></header>

    <div class="container-3d">
      <h3 class="section-title">å£¹ã€ç‰©æ–™ç•°å‹•ç™»éŒ„</h3>
      <form id="materialForm">
        <div class="form-row">
          <div><label>ç•°å‹•æ—¥æœŸ</label><input type="date" id="mainDate" required /></div>
          <div><label>ä½œæ¥­é¡å‹</label>
            <select id="transType">
              <option value="é ˜æ–™">é ˜æ–™ (Take)</option>
              <option value="å€Ÿç”¨">å€Ÿç”¨ (Borrow)</option>
              <option value="é€€æ–™">é€€æ–™ (Return)</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div><label>å–®è™Ÿ</label><input type="text" id="orderNo" required /></div>
          <div><label>é ˜/é€€/å€Ÿç”¨äºº</label><input type="text" id="personName" required /></div>
          <div><label>ç™¼/æ”¶æ–™ç¶“è¾¦</label><input type="text" id="staffName" required /></div>
        </div>
        <div class="form-row">
          <div><label>æ–™è™Ÿæœå°‹ (10ä½)</label><input type="text" id="partNoSearch" maxlength="10" oninput="handlePartNoInput(this.value)" /></div>
          <div><label>é¡åˆ¥</label>
            <select id="category" onchange="renderMaterials()">
              <option value="">-- é¸æ“‡é¡åˆ¥ --</option>
              <option value="A">A é¡ (ç¤™å­)</option>
              <option value="B">B é¡ (éµä»¶)</option>
              <option value="C">C é¡ (ç·šæ)</option>
              <option value="F">F é¡ (è®Šå£“å™¨)</option>
              <option value="H">H é¡ (é–‹é—œ)</option>
              <option value="D">D é¡ (é›»è¡¨)</option>
            </select>
          </div>
        </div>
        <div id="materialsContainer"></div>
        <div id="qtySection" style="display:none; margin-top:15px;">
          <div class="form-row">
            <div><label>æ•¸é‡</label><input type="number" id="qty" min="1" required /></div>
            <div><label>å–®ä½</label><input type="text" id="unit" readonly /></div>
            <div><label>è©•åƒ¹</label><select id="evalType"><option>0æ–°</option><option>1èˆŠ</option></select></div>
          </div>
          <button type="submit" class="btn-primary">ğŸ’¾ å„²å­˜ç´€éŒ„ä¸¦æ›´æ–°åº«å­˜</button>
        </div>
      </form>
    </div>

    <div class="container-3d">
      <h3 class="section-title">è²³ã€æ­·å²ç´€éŒ„æŸ¥è©¢</h3>
      <div class="search-grid">
        <input type="text" id="searchPerson" placeholder="æœå°‹å§“å..." oninput="filterRecords()">
        <input type="text" id="searchStaff" placeholder="æœå°‹ç¶“è¾¦äºº..." oninput="filterRecords()">
        <input type="text" id="searchPartNo" placeholder="æœå°‹æ–™è™Ÿ..." oninput="filterRecords()">
        <select id="searchYear" onchange="filterRecords()"><option value="">æ‰€æœ‰å¹´ä»½</option></select>
        <select id="searchMonth" onchange="filterRecords()"><option value="">æ‰€æœ‰æœˆä»½</option></select>
      </div>
      <div id="logList"></div>
      <button onclick="clearAllRecords()" style="color:red; background:none; border:none; cursor:pointer; font-size:0.8rem; margin-top:10px;">âš ï¸ æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ­·å²ç´€éŒ„</button>
    </div>

    <div class="form-row">
      <div class="container-3d">
        <h3 class="section-title">åƒã€å³æ™‚åº«å­˜æŸ¥è©¢</h3>
        <input type="text" id="invQueryPart" placeholder="è¼¸å…¥æ–™è™Ÿ...">
        <button class="btn-outline" onclick="checkStock()">ğŸ” æŸ¥è©¢åº«å­˜</button>
        <button class="btn-outline" onclick="adjustStock()">âš™ï¸ è¨­å®š/èª¿æ•´åˆå§‹åº«å­˜</button>
        <div id="stockResult" style="margin-top:10px; font-weight:bold; color:var(--ukiyo-mid-blue);"></div>
      </div>
      <div class="container-3d">
        <h3 class="section-title">è‚†ã€å­˜è²¨åˆ†æèˆ‡é æ¸¬</h3>
        <input type="text" id="analyzePart" placeholder="è¼¸å…¥æ–™è™Ÿ...">
        <button class="btn-outline" onclick="analyzeStock()">ğŸ“Š ç”¢ç”Ÿåˆ†æå ±å‘Š</button>
        <button class="btn-outline" onclick="setAlert()">ğŸ”” è¨­å®šé è­¦å€¼</button>
        <div id="analyzeResult" style="margin-top:10px; font-size:0.85rem;"></div>
      </div>
    </div>
  </div>

<script>
  const materialDict = {
    A: ["1030420013 æ‡¸å‚ç¤™å­ Cå‹ 10000ç£…", "1030500000 èšåˆæŸ±å‹ç¤™å­ 11.4kV"],
    B: ["1006000006 è·¯ç‡ˆé–‹é—œ 1P 240Vac", "1104000184 å£“æ¥ç«¯å­ éŠ… AWG #1"],
    C: ["1102000021 25KVäº¤é€£PEé›»åŠ›é›»çºœ 500MCM", "1102050095 600V PVCé¢¨é›¨ç·š 8ãœ2"],
    F: ["1000010064 æ¡¿ä¸Šè®Šå£“å™¨ 6.9kV 25kVA", "1000010131 äº­ç½®å¼è®Šå£“å™¨ 25kVA"],
    H: ["1008040010 æ¶ç©ºè‡ªå‹•ç·šè·¯é–‹é—œ 15kV", "1012010011 ç†”çµ²éˆé–‹é—œ 7.8/15kV"],
    D: ["1310040000 é›»å­å¼é›»è¡¨ å–®ç›¸ä¸‰ç·š", "1310240001 PCRå°å°é– Aå‹"]
  };

  let records = JSON.parse(localStorage.getItem("tp_records") || "[]");
  let stocks = JSON.parse(localStorage.getItem("tp_stocks") || "{}");
  let alerts = JSON.parse(localStorage.getItem("tp_alerts") || "{}");
  let selectedItem = "";

  // åˆå§‹åŒ–æ—¥æœŸèˆ‡ä¸‹æ‹‰é¸å–®
  document.getElementById("mainDate").valueAsDate = new Date();
  const yearSelect = document.getElementById("searchYear");
  for(let y=2024; y<=2026; y++) yearSelect.add(new Option(y+"å¹´", y));
  const monthSelect = document.getElementById("searchMonth");
  for(let m=1; m<=12; m++) monthSelect.add(new Option(m+"æœˆ", m.toString().padStart(2,'0')));

  function handlePartNoInput(val) {
    if (val.length >= 4) {
      for (let cat in materialDict) {
        let match = materialDict[cat].find(i => i.includes(val));
        if (match) { 
          document.getElementById("category").value = cat; 
          renderMaterials(); 
          selectMaterial(match); 
          break; 
        }
      }
    }
  }

  function renderMaterials() {
    const cat = document.getElementById("category").value;
    const box = document.getElementById("materialsContainer");
    box.innerHTML = "";
    if (!cat) return;
    materialDict[cat].forEach(m => {
      const btn = document.createElement("button");
      btn.className = `material-btn ${selectedItem === m ? 'active' : ''}`;
      btn.innerText = m; btn.type = "button";
      btn.onclick = () => selectMaterial(m);
      box.appendChild(btn);
    });
  }

  function selectMaterial(item) {
    selectedItem = item;
    document.getElementById("qtySection").style.display = "block";
    document.getElementById("unit").value = (item.includes("ç·š") || item.includes("é›»çºœ")) ? "M" : "PC";
    renderMaterials();
  }

  // å„²å­˜é‚è¼¯ (åŒ…å«åº«å­˜é€£å‹•)
  document.getElementById("materialForm").onsubmit = function(e) {
    e.preventDefault();
    const partNo = selectedItem.split(" ")[0];
    const qty = parseInt(document.getElementById("qty").value);
    const type = document.getElementById("transType").value;

    const data = {
      id: Date.now(),
      date: document.getElementById("mainDate").value,
      type: type,
      orderNo: document.getElementById("orderNo").value,
      person: document.getElementById("personName").value,
      staff: document.getElementById("staffName").value,
      item: selectedItem,
      partNo: partNo,
      qty: qty,
      unit: document.getElementById("unit").value
    };

    // æ›´æ–°åº«å­˜
    if(!stocks[partNo]) stocks[partNo] = 0;
    if(type === "é ˜æ–™" || type === "å€Ÿç”¨") stocks[partNo] -= qty;
    else stocks[partNo] += qty;

    records.unshift(data);
    saveData();
    filterRecords();
    alert("å„²å­˜æˆåŠŸï¼åº«å­˜å·²åŒæ­¥æ›´æ–°ã€‚");
    this.reset();
    document.getElementById("qtySection").style.display = "none";
  };

  function filterRecords() {
    const p = document.getElementById("searchPerson").value.toLowerCase();
    const s = document.getElementById("searchStaff").value.toLowerCase();
    const no = document.getElementById("searchPartNo").value;
    const y = document.getElementById("searchYear").value;
    const m = document.getElementById("searchMonth").value;

    const filtered = records.filter(r => {
      return (!p || r.person.toLowerCase().includes(p)) &&
             (!s || r.staff.toLowerCase().includes(s)) &&
             (!no || r.partNo.includes(no)) &&
             (!y || r.date.startsWith(y)) &&
             (!m || r.date.split("-")[1] === m);
    });

    const list = document.getElementById("logList");
    list.innerHTML = filtered.map(r => `
      <div class="record-li">
        <strong>[${r.type}] ${r.date}</strong> | å–®è™Ÿ: ${r.orderNo}<br>
        ææ–™: ${r.item} <span style="color:blue;">(${r.qty} ${r.unit})</span><br>
        é ˜ç”¨äºº: ${r.person} | ç¶“è¾¦: ${r.staff}
        <button class="btn-delete" onclick="deleteRec(${r.id})">ğŸ—‘ï¸</button>
      </div>
    `).join("") || "<p style='text-align:center; color:#999;'>æŸ¥ç„¡ç›¸æ‡‰ç´€éŒ„</p>";
  }

  function deleteRec(id) {
    if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) {
      records = records.filter(r => r.id !== id);
      saveData();
      filterRecords();
    }
  }

  // åº«å­˜åŠŸèƒ½
  function checkStock() {
    const part = document.getElementById("invQueryPart").value;
    if(!part) return alert("è«‹è¼¸å…¥æ–™è™Ÿ");
    const count = stocks[part] || 0;
    const alertVal = alerts[part] || "æœªè¨­å®š";
    document.getElementById("stockResult").innerHTML = `ç›®å‰åº«å­˜ï¼š${count} | é è­¦å€¼ï¼š${alertVal}`;
  }

  function adjustStock() {
    const part = document.getElementById("invQueryPart").value;
    if(!part) return alert("è«‹å…ˆè¼¸å…¥æ–™è™Ÿ");
    const newStock = prompt(`è«‹è¼¸å…¥ ${part} çš„åˆå§‹/èª¿æ•´å¾Œåº«å­˜æ•¸é‡:`, stocks[part] || 0);
    if(newStock !== null) {
      stocks[part] = parseInt(newStock);
      saveData();
      alert("åº«å­˜èª¿æ•´å®Œæˆ");
      checkStock();
    }
  }

  // åˆ†æèˆ‡é è­¦
  function analyzeStock() {
    const part = document.getElementById("analyzePart").value;
    if(!part) return alert("è«‹è¼¸å…¥æ–™è™Ÿ");
    const history = records.filter(r => r.partNo === part);
    const totalOut = history.filter(r => r.type === "é ˜æ–™").reduce((sum, r) => sum + r.qty, 0);
    document.getElementById("analyzeResult").innerHTML = `
      é …ç›®: ${part}<br>æ­·å²ç¸½é ˜ç”¨é‡: ${totalOut}<br>
      å»ºè­°å®‰å…¨å­˜é‡: ${Math.ceil(totalOut * 0.2 + 5)} (åŸºæ–¼æ¶ˆè€—é‡é æ¸¬)
    `;
  }

  function setAlert() {
    const part = document.getElementById("analyzePart").value;
    if(!part) return alert("è«‹è¼¸å…¥æ–™è™Ÿ");
    const val = prompt("è«‹è¨­å®šä½æ–¼å¤šå°‘æ•¸é‡æ™‚ç™¼å‡ºé è­¦:");
    if(val) {
      alerts[part] = parseInt(val);
      saveData();
      alert("é è­¦è¨­å®šæˆåŠŸ");
    }
  }

  function saveData() {
    localStorage.setItem("tp_records", JSON.stringify(records));
    localStorage.setItem("tp_stocks", JSON.stringify(stocks));
    localStorage.setItem("tp_alerts", JSON.stringify(alerts));
  }

  function clearAllRecords() {
    if(confirm("è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰æ­·å²ç´€éŒ„èˆ‡åº«å­˜è³‡æ–™ï¼ç¢ºå®šåŸ·è¡Œï¼Ÿ")) {
      localStorage.clear();
      location.reload();
    }
  }

  // é é¢åŠ è¼‰å¾ŒåŸ·è¡Œä¸€æ¬¡éæ¿¾
  filterRecords();
</script>
</body>
</html>
