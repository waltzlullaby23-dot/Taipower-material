<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°é›»ææ–™ç®¡ç†ç³»çµ± - å…¨åŠŸèƒ½æ•´åˆç‰ˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Orbitron:wght@600;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --ukiyo-deep-blue: #1D3B56;
      --ukiyo-mid-blue: #2A587A;
      --ukiyo-light-blue: #6B93B8;
      --ukiyo-foam: #F0F4F5;
      --ukiyo-sky: #E6D3A3;
      --ukiyo-paper: #F2E6D9;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-border: rgba(255, 255, 255, 0.9);
      --danger-red: #d64545;
      --safe-green: #2ecc71;
      --warning-orange: #f39c12;
    }
    
    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0;
      padding: 0;
      color: #1a202c;
      background-color: var(--ukiyo-sky);
      min-height: 100vh;
    }

    /* èƒŒæ™¯å‹•ç•«å±¤ (ä¿æŒåŸæ¨£) */
    .ukiyo-scene {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1; overflow: hidden;
      background: radial-gradient(circle at 50% 30%, #f7f0e6, var(--ukiyo-sky));
      pointer-events: none;
    }
    .mt-fuji {
      position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 150px solid transparent; border-right: 150px solid transparent;
      border-bottom: 200px solid #2c3e50;
    }
    .wave { position: absolute; bottom: 0; width: 200%; height: 100%; background-repeat: repeat-x; background-position: bottom; }
    .wave-back { z-index: 2; height: 45%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 180' preserveAspectRatio='none'%3E%3Cpath d='M0,120 C150,150 250,80 400,110 C550,140 650,80 800,110 L800,180 L0,180 Z' fill='%232A587A' opacity='0.8'/%3E%3C/svg%3E"); animation: moveWave 25s linear infinite; }
    .wave-mid { z-index: 3; height: 40%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 180' preserveAspectRatio='none'%3E%3Cpath d='M0,100 C200,60 350,140 600,80 C750,40 800,100 800,100 L800,180 L0,180 Z' fill='%236B93B8' opacity='0.9'/%3E%3C/svg%3E"); animation: moveWave 15s linear infinite reverse; }
    .wave-front { z-index: 4; height: 35%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320' preserveAspectRatio='none'%3E%3Cpath fill='%231D3B56' fill-opacity='1' d='M0,160L48,176C96,192,192,224,288,224C384,224,480,192,576,165.3C672,139,768,117,864,128C960,139,1056,181,1152,197.3C1248,213,1344,203,1392,197.3L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E"); animation: moveWave 10s linear infinite; }
    @keyframes moveWave { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    /* UI å…§å®¹å±¤ */
    .content-wrapper { 
      position: relative; z-index: 10; padding: 20px 16px 80px; 
      max-width: 950px; margin: 0 auto;
    }

    header { 
      background: var(--ukiyo-deep-blue); color: white; border-radius: 12px; 
      padding: 20px; text-align: center; box-shadow: 0 10px 25px rgba(29, 59, 86, 0.5); 
      border: 2px solid #D4AF37; margin-bottom: 25px;
    }

    /* Tab å°èˆªåˆ— */
    .nav-tabs {
      display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
    }
    .nav-btn {
      flex: 1; padding: 12px; border: none; border-radius: 8px;
      background: rgba(255,255,255,0.6); font-weight: 700; color: var(--ukiyo-deep-blue);
      cursor: pointer; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      min-width: 120px;
    }
    .nav-btn.active {
      background: var(--ukiyo-deep-blue); color: #fff;
      transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    .container-3d { 
      background: var(--glass-bg); backdrop-filter: blur(10px); 
      border-radius: 20px; padding: 30px; 
      box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
      border: 1px solid var(--glass-border); margin-bottom: 30px;
      display: none; /* é è¨­éš±è—ï¼Œé€é Tab åˆ‡æ›é¡¯ç¤º */
    }
    .container-3d.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    h3.section-title { color: var(--ukiyo-deep-blue); border-left: 6px solid var(--danger-red); padding-left: 15px; margin: 25px 0 15px; font-weight: 900; }
    input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 15px; margin-bottom: 15px; }
    .form-row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; align-items: end; }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-save { 
      width: 100%; padding: 15px; border: none; border-radius: 12px; 
      background: linear-gradient(45deg, var(--ukiyo-deep-blue), var(--ukiyo-mid-blue)); 
      color: white; font-size: 1.1rem; font-weight: 900; cursor: pointer; 
      transition: 0.3s; margin-top: 10px;
    }
    .btn-save:hover { background: var(--danger-red); transform: translateY(-2px); }
    
    .btn-search {
      background: var(--ukiyo-mid-blue); color: white; padding: 12px; 
      border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
    }

    /* åˆ—è¡¨èˆ‡è¡¨æ ¼æ¨£å¼ */
    #materialsContainer { 
      display: flex; flex-direction: column; gap: 8px; 
      max-height: 200px; overflow-y: auto; 
      padding: 10px; border: 1px solid #ddd; border-radius: 8px; 
      background: white; margin-top: 10px;
    }
    .material-btn { 
      padding: 10px; background: #f9f9f9; border: 1px solid #eee; 
      cursor: pointer; border-radius: 6px; text-align: left; transition: 0.2s;
    }
    .material-btn:hover { background: #eef2f5; }
    .material-btn.active { background: var(--ukiyo-mid-blue); color: white; }

    .record-li { 
      background: white; border-radius: 12px; padding: 15px; 
      margin-bottom: 12px; border-left: 5px solid var(--ukiyo-mid-blue); 
      position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    .btn-delete { 
      position: absolute; right: 15px; top: 15px; background: #ffeaea; 
      border: 1px solid #ffcccc; color: red; cursor: pointer; 
      padding: 5px 10px; border-radius: 5px; font-size: 0.8rem;
    }

    /* åº«å­˜è¡¨æ ¼ */
    .stock-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .stock-table th, .stock-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .stock-table th { background-color: var(--ukiyo-foam); color: var(--ukiyo-deep-blue); }
    .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; color: white; }
    .status-ok { background-color: var(--safe-green); }
    .status-low { background-color: var(--danger-red); }
    .status-warn { background-color: var(--warning-orange); }

    /* ç°½åæª” */
    .ukiyo-signature {
      position: fixed; left: 20px; bottom: 20px; z-index: 100; font-weight: 900; padding: 10px;
      background: #F2E6D9; border: 2px solid #1D3B56; border-radius: 5px; transform: rotate(-5deg); cursor: pointer;
      box-shadow: 3px 3px 0px #1D3B56;
    }

    @media (max-width: 600px) { 
      .form-row, .form-row-3, .form-row-4 { grid-template-columns: 1fr; } 
      .nav-tabs { gap: 5px; }
      .nav-btn { font-size: 0.9rem; padding: 8px; }
    }
  </style>
</head>
<body>

  <div class="ukiyo-scene">
    <div class="mt-fuji"></div>
    <div class="wave wave-back"></div>
    <div class="wave wave-mid"></div>
    <div class="wave wave-front"></div>
  </div>

  <div class="content-wrapper">
    <header>
      <div style="font-weight:900; font-size: 1.5rem; letter-spacing: 2px;">å°é›»ææ–™ç®¡ç†ç³»çµ±</div>
      <div style="font-size:0.9rem; opacity:0.9; margin-top:5px;">æ•´åˆä¿®å¾©ç‰ˆ v2.0</div>
    </header>

    <div class="nav-tabs">
      <button class="nav-btn active" onclick="switchTab('input')">ğŸ“ è³‡æ–™è¼¸å…¥</button>
      <button class="nav-btn" onclick="switchTab('search')">ğŸ” æ­·å²æŸ¥è©¢</button>
      <button class="nav-btn" onclick="switchTab('inventory')">ğŸ“¦ å³æ™‚åº«å­˜</button>
      <button class="nav-btn" onclick="switchTab('analysis')">ğŸ“Š åˆ†æèˆ‡é æ¸¬</button>
    </div>

    <div id="tab-input" class="container-3d active">
      <form id="materialForm">
        <h3 class="section-title">å£¹ã€åŸºæœ¬è³‡è¨Š</h3>
        <div class="form-row">
          <div><label>ç•°å‹•æ—¥æœŸ</label><input type="date" id="mainDate" required /></div>
          <div><label>ä½œæ¥­é¡å‹</label>
            <select id="transType">
              <option value="é ˜æ–™">é ˜æ–™ (Take)</option>
              <option value="å€Ÿç”¨">å€Ÿç”¨ (Borrow)</option>
              <option value="é€€æ–™">é€€æ–™ (Return)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div><label>å–®è™Ÿ</label><input type="text" id="orderNo" placeholder="è«‹è¼¸å…¥å–®è™Ÿ" required /></div>
          <div><label>é ˜/é€€/å€Ÿç”¨äººå§“å</label><input type="text" id="personName" required /></div>
        </div>
        
        <div class="form-row">
          <div><label>ç™¼/æ”¶æ–™ç¶“è¾¦äºº</label><input type="text" id="staffName" required /></div>
          <div><label>10ä½æ–™è™Ÿæœå°‹ (å¸¶å‡ºææ–™)</label><input type="text" id="partNoInput" maxlength="10" placeholder="è¼¸å…¥æ–™è™Ÿè‡ªå‹•å¸¶å‡º" oninput="handlePartNoInput(this.value)" /></div>
        </div>

        <h3 class="section-title">è²³ã€ææ–™é¸æ“‡</h3>
        <select id="category" onchange="renderMaterials()">
          <option value="">-- è«‹é¸æ“‡ææ–™é¡åˆ¥ --</option>
          <option value="A">A é¡ (ç¤™å­)</option>
          <option value="B">B é¡ (éµä»¶)</option>
          <option value="C">C é¡ (ç·šæ)</option>
          <option value="F">F é¡ (è®Šå£“å™¨)</option>
          <option value="H">H é¡ (é–‹é—œ)</option>
          <option value="D">D é¡ (é›»è¡¨)</option>
        </select>

        <div id="materialsContainer">
          <div style="color:#888; text-align:center; padding:20px;">è«‹å…ˆé¸æ“‡é¡åˆ¥æˆ–è¼¸å…¥æ–™è™Ÿ</div>
        </div>

        <div id="qtySection" style="display:none; margin-top:20px;">
          <div class="form-row-3">
            <div><label>æ•¸é‡</label><input type="number" id="qty" min="1" required /></div>
            <div><label>å–®ä½</label><input type="text" id="unit" required /></div>
            <div><label>è©•åƒ¹é¡å‹</label>
              <select id="evalType">
                <option value="0æ–°">0æ–°</option>
                <option value="1èˆŠ">1èˆŠ</option>
              </select>
            </div>
          </div>
          <button type="submit" class="btn-save">ğŸ’¾ å„²å­˜ç‰©æ–™ç´€éŒ„</button>
        </div>
      </form>
    </div>

    <div id="tab-search" class="container-3d">
      <h3 class="section-title">ğŸ” é€²éšæ­·å²æœå°‹</h3>
      <div class="form-row">
        <div><label>å§“åæœå°‹ (é ˜/é€€/å€Ÿ)</label><input type="text" id="searchPerson" placeholder="è¼¸å…¥å§“å..." oninput="filterRecords()"></div>
        <div><label>ç¶“è¾¦äººæœå°‹ (æ”¶/ç™¼)</label><input type="text" id="searchStaff" placeholder="è¼¸å…¥ç¶“è¾¦äºº..." oninput="filterRecords()"></div>
      </div>
      <div class="form-row">
        <div><label>æ–™è™Ÿæœå°‹</label><input type="text" id="searchPartNo" placeholder="è¼¸å…¥æ–™è™Ÿ..." oninput="filterRecords()"></div>
        <div><label>æ—¥æœŸéæ¿¾ (å¹´/æœˆ)</label><input type="month" id="searchMonth" onchange="filterRecords()"></div>
      </div>
      <button onclick="clearFilters()" style="width:100%; margin-bottom:15px; padding:10px; background:#eee; border:none; border-radius:8px; cursor:pointer;">âŒ æ¸…é™¤æœå°‹æ¢ä»¶</button>
      
      <div id="logList"></div>
    </div>

    <div id="tab-inventory" class="container-3d">
      <h3 class="section-title">ğŸ“¦ åº«å­˜è¨­å®šèˆ‡æŸ¥è©¢</h3>
      <div class="form-row-3" style="background: var(--ukiyo-foam); padding:15px; border-radius:10px; margin-bottom:20px;">
        <div style="grid-column: 1 / -1;"><strong>ğŸ”§ è¨­å®šåˆå§‹åº«å­˜</strong></div>
        <div><label>æ–™è™Ÿ</label><input type="text" id="stockPartNo" placeholder="è¼¸å…¥å®Œæ•´æ–™è™Ÿ"></div>
        <div><label>åˆå§‹æ•¸é‡</label><input type="number" id="stockInitQty" placeholder="0"></div>
        <div><label>å‹•ä½œ</label><button class="btn-search" style="width:100%" onclick="setInitialStock()">è¨­å®š/æ›´æ–°</button></div>
      </div>
      
      <div><label>ğŸ” å¿«é€Ÿéæ¿¾åº«å­˜è¡¨</label><input type="text" id="filterStockInput" placeholder="è¼¸å…¥æ–™è™Ÿæˆ–å“å..." oninput="renderInventoryTable()"></div>
      
      <div style="overflow-x: auto;">
        <table class="stock-table">
          <thead>
            <tr>
              <th>æ–™è™Ÿ</th>
              <th>å“å</th>
              <th>åˆå§‹</th>
              <th>ç•°å‹•</th>
              <th>ç›®å‰åº«å­˜</th>
            </tr>
          </thead>
          <tbody id="inventoryBody"></tbody>
        </table>
      </div>
    </div>

    <div id="tab-analysis" class="container-3d">
      <h3 class="section-title">ğŸ“Š å­˜è²¨é è­¦åˆ†æå ±å‘Š</h3>
      <div class="form-row-3" style="background: #fff3cd; padding:15px; border-radius:10px; margin-bottom:20px;">
        <div style="grid-column: 1 / -1;"><strong>âš ï¸ è¨­å®šå®‰å…¨å­˜é‡ (é è­¦å€¼)</strong></div>
        <div><label>æ–™è™Ÿ</label><input type="text" id="safePartNo" placeholder="è¼¸å…¥å®Œæ•´æ–™è™Ÿ"></div>
        <div><label>å®‰å…¨å­˜é‡</label><input type="number" id="safeQty" placeholder="ä¾‹å¦‚: 10"></div>
        <div><label>å‹•ä½œ</label><button class="btn-search" style="background:#e67e22; width:100%" onclick="setSafetyStock()">è¨­å®šé è­¦</button></div>
      </div>

      <div id="analysisReport"></div>
    </div>

  </div>

  <div class="ukiyo-signature" onclick="toggleSignature(this)">
    è¨­è¨ˆäººï¼š<span id="sigName" hidden>ä¸‰æœ¨</span>
  </div>

<script>
  // 1. è³‡æ–™åº«å®šç¾©
  const materialDict = {
    A: ["1030420013 æ‡¸å‚ç¤™å­ Cå‹ 10000ç£…", "1030500000 èšåˆæŸ±å‹ç¤™å­ 11.4kV"],
    B: ["1006000006 è·¯ç‡ˆé–‹é—œ 1P 240Vac", "1104000184 å£“æ¥ç«¯å­ éŠ… AWG #1"],
    C: ["1102000021 25KVäº¤é€£PEé›»åŠ›é›»çºœ 500MCM", "1102050095 600V PVCé¢¨é›¨ç·š 8ãœ2"],
    F: ["1000010064 æ¡¿ä¸Šè®Šå£“å™¨ 6.9kV 25kVA", "1000010131 äº­ç½®å¼è®Šå£“å™¨ 25kVA"],
    H: ["1008040010 æ¶ç©ºè‡ªå‹•ç·šè·¯é–‹é—œ 15kV", "1012010011 ç†”çµ²éˆé–‹é—œ 7.8/15kV"],
    D: ["1310040000 é›»å­å¼é›»è¡¨ å–®ç›¸ä¸‰ç·š", "1310240001 PCRå°å°é– Aå‹"]
  };

  // 2. åˆå§‹åŒ–è³‡æ–™ (LocalStorage)
  let records = JSON.parse(localStorage.getItem("taipower_v1") || "[]");
  // å­˜åº«å­˜è¨­å®š: { "æ–™è™Ÿ": { initial: 100, safety: 10 } }
  let stockSettings = JSON.parse(localStorage.getItem("taipower_stock_settings") || "{}");
  
  let selectedItem = "";
  let selectedPartNo = "";

  // è¨­ç½®ç•¶å¤©æ—¥æœŸ
  document.getElementById("mainDate").valueAsDate = new Date();

  // --- é é¢åˆ‡æ›é‚è¼¯ ---
  function switchTab(tabName) {
    document.querySelectorAll('.container-3d').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById('tab-' + tabName).classList.add('active');
    // æ‰¾å‡ºå°æ‡‰æŒ‰éˆ•åŠ  active (é€™è£¡ç°¡å–®ç”¨ç´¢å¼•æˆ–éæ­·)
    const btns = document.querySelectorAll('.nav-btn');
    if(tabName === 'input') btns[0].classList.add('active');
    if(tabName === 'search') { btns[1].classList.add('active'); filterRecords(); }
    if(tabName === 'inventory') { btns[2].classList.add('active'); renderInventoryTable(); }
    if(tabName === 'analysis') { btns[3].classList.add('active'); renderAnalysisReport(); }
  }

  // --- è³‡æ–™è¼¸å…¥é‚è¼¯ ---
  function handlePartNoInput(val) {
    if (val.length === 10) {
      for (const cat in materialDict) {
        const match = materialDict[cat].find(i => i.startsWith(val));
        if (match) {
          document.getElementById("category").value = cat;
          renderMaterials();
          selectMaterial(match);
          return;
        }
      }
    }
  }

  function renderMaterials() {
    const cat = document.getElementById("category").value;
    const box = document.getElementById("materialsContainer");
    box.innerHTML = "";
    if (!cat) return;
    
    materialDict[cat].forEach(m => {
      const btn = document.createElement("button");
      btn.className = "material-btn";
      btn.innerText = m;
      btn.type = "button";
      btn.onclick = () => selectMaterial(m);
      if (selectedItem === m) btn.classList.add("active");
      box.appendChild(btn);
    });
  }

  function selectMaterial(item) {
    selectedItem = item;
    selectedPartNo = item.split(" ")[0];
    document.getElementById("partNoInput").value = selectedPartNo;
    document.getElementById("qtySection").style.display = "block";
    document.getElementById("unit").value = (item.includes("ç·š") || item.includes("é›»çºœ")) ? "M" : "PC";
    renderMaterials();
  }

  document.getElementById("materialForm").onsubmit = function(e) {
    e.preventDefault();
    const data = {
      id: Date.now(),
      date: document.getElementById("mainDate").value, // YYYY-MM-DD
      type: document.getElementById("transType").value,
      orderNo: document.getElementById("orderNo").value,
      item: selectedItem,
      partNo: selectedPartNo,
      qty: parseInt(document.getElementById("qty").value),
      unit: document.getElementById("unit").value,
      person: document.getElementById("personName").value,
      staff: document.getElementById("staffName").value,
      eval: document.getElementById("evalType").value
    };
    records.unshift(data);
    localStorage.setItem("taipower_v1", JSON.stringify(records));
    alert("âœ… ç´€éŒ„å·²å„²å­˜ï¼");
    // é‡ç½®è¡¨å–®
    this.reset();
    document.getElementById("qtySection").style.display = "none";
    document.getElementById("materialsContainer").innerHTML = '<div style="color:#888; text-align:center; padding:20px;">è«‹å…ˆé¸æ“‡é¡åˆ¥æˆ–è¼¸å…¥æ–™è™Ÿ</div>';
  };

  // --- æ­·å²æŸ¥è©¢èˆ‡åˆªé™¤é‚è¼¯ ---
  function filterRecords() {
    const qPerson = document.getElementById("searchPerson").value.toLowerCase();
    const qStaff = document.getElementById("searchStaff").value.toLowerCase();
    const qPart = document.getElementById("searchPartNo").value;
    const qMonth = document.getElementById("searchMonth").value; // YYYY-MM

    const list = document.getElementById("logList");
    list.innerHTML = "";

    const filtered = records.filter(r => {
      const matchPerson = !qPerson || r.person.toLowerCase().includes(qPerson);
      const matchStaff = !qStaff || r.staff.toLowerCase().includes(qStaff);
      const matchPart = !qPart || r.item.includes(qPart);
      const matchDate = !qMonth || r.date.startsWith(qMonth);
      return matchPerson && matchStaff && matchPart && matchDate;
    });

    if (filtered.length === 0) {
      list.innerHTML = "<p style='text-align:center; color:#666;'>æŸ¥ç„¡è³‡æ–™</p>";
      return;
    }

    filtered.forEach(r => {
      list.innerHTML += `
        <div class="record-li">
          <div style="font-size:0.85rem; color:#666;">${r.date} | å–®è™Ÿ: ${r.orderNo} | ç¶“è¾¦: ${r.staff}</div>
          <strong style="font-size:1.1rem; color:var(--ukiyo-deep-blue);">${r.type} - ${r.person}</strong><br>
          <div style="margin-top:5px; font-weight:bold;">${r.item}</div>
          <div style="margin-top:5px; color:#d35400;">æ•¸é‡: ${r.qty} ${r.unit} (${r.eval})</div>
          <button class="btn-delete" onclick="deleteRec(${r.id})">åˆªé™¤</button>
        </div>
      `;
    });
  }

  function clearFilters() {
    document.getElementById("searchPerson").value = "";
    document.getElementById("searchStaff").value = "";
    document.getElementById("searchPartNo").value = "";
    document.getElementById("searchMonth").value = "";
    filterRecords();
  }

  function deleteRec(id) {
    if(confirm("âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
      records = records.filter(r => r.id !== id);
      localStorage.setItem("taipower_v1", JSON.stringify(records));
      filterRecords(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      alert("å·²åˆªé™¤ç´€éŒ„ã€‚");
    }
  }

  // --- åº«å­˜è¨ˆç®—æ ¸å¿ƒé‚è¼¯ ---
  function calculateInventoryData() {
    // 1. å–å¾—æ‰€æœ‰æ–™è™Ÿæ¸…å–® (åŒ…å«è¨­å®šéçš„å’Œæœ‰ç´€éŒ„çš„)
    let allPartNos = new Set();
    records.forEach(r => allPartNos.add(r.partNo));
    Object.keys(stockSettings).forEach(k => allPartNos.add(k));

    let inventoryMap = {};

    allPartNos.forEach(pNo => {
      // æ‰¾å‡ºè©²æ–™è™Ÿçš„åç¨± (å¾è¨­å®šæˆ–ç´€éŒ„ä¸­æ‰¾)
      let name = "";
      const rec = records.find(r => r.partNo === pNo);
      if(rec) name = rec.item;
      
      const settings = stockSettings[pNo] || { initial: 0, safety: 0 };
      let currentQty = settings.initial;
      let historyDelta = 0;

      // è¨ˆç®—ç•°å‹•
      records.filter(r => r.partNo === pNo).forEach(r => {
        if (r.type === "é ˜æ–™") historyDelta -= r.qty;
        if (r.type === "å€Ÿç”¨") historyDelta -= r.qty; // å€Ÿç”¨è¦–ç‚ºåº«å­˜æ¸›å°‘
        if (r.type === "é€€æ–™") historyDelta += r.qty;
      });

      inventoryMap[pNo] = {
        name: name || pNo, // è‹¥æ²’åç¨±é¡¯ç¤ºæ–™è™Ÿ
        initial: settings.initial,
        delta: historyDelta,
        current: currentQty + historyDelta,
        safety: settings.safety
      };
    });
    return inventoryMap;
  }

  // --- å³æ™‚åº«å­˜é é¢é‚è¼¯ ---
  function setInitialStock() {
    const pNo = document.getElementById("stockPartNo").value;
    const val = parseInt(document.getElementById("stockInitQty").value);
    if (!pNo || isNaN(val)) { alert("è«‹è¼¸å…¥å®Œæ•´æ–™è™Ÿèˆ‡æ•¸é‡"); return; }
    
    if (!stockSettings[pNo]) stockSettings[pNo] = { initial: 0, safety: 0 };
    stockSettings[pNo].initial = val;
    localStorage.setItem("taipower_stock_settings", JSON.stringify(stockSettings));
    alert(`æ–™è™Ÿ ${pNo} åˆå§‹åº«å­˜å·²è¨­å®šç‚º ${val}`);
    renderInventoryTable();
  }

  function renderInventoryTable() {
    const filter = document.getElementById("filterStockInput").value.toLowerCase();
    const data = calculateInventoryData();
    const tbody = document.getElementById("inventoryBody");
    tbody.innerHTML = "";

    Object.keys(data).forEach(pNo => {
      const item = data[pNo];
      if (filter && !item.name.toLowerCase().includes(filter) && !pNo.includes(filter)) return;

      tbody.innerHTML += `
        <tr>
          <td>${pNo}</td>
          <td>${item.name}</td>
          <td>${item.initial}</td>
          <td style="color:${item.delta < 0 ? 'red' : 'green'}">${item.delta > 0 ? '+'+item.delta : item.delta}</td>
          <td style="font-weight:900; font-size:1.1rem;">${item.current}</td>
        </tr>
      `;
    });
  }

  // --- åˆ†æå ±å‘Šé‚è¼¯ ---
  function setSafetyStock() {
    const pNo = document.getElementById("safePartNo").value;
    const val = parseInt(document.getElementById("safeQty").value);
    if (!pNo || isNaN(val)) { alert("è«‹è¼¸å…¥å®Œæ•´æ–™è™Ÿèˆ‡æ•¸é‡"); return; }

    if (!stockSettings[pNo]) stockSettings[pNo] = { initial: 0, safety: 0 };
    stockSettings[pNo].safety = val;
    localStorage.setItem("taipower_stock_settings", JSON.stringify(stockSettings));
    alert(`æ–™è™Ÿ ${pNo} å®‰å…¨å­˜é‡è­¦ç¤ºå€¼å·²è¨­å®šç‚º ${val}`);
    renderAnalysisReport();
  }

  function renderAnalysisReport() {
    const data = calculateInventoryData();
    const container = document.getElementById("analysisReport");
    container.innerHTML = "";

    let hasData = false;
    Object.keys(data).forEach(pNo => {
      const item = data[pNo];
      // åªé¡¯ç¤ºæœ‰è¨­å®šå®‰å…¨å­˜é‡çš„ï¼Œæˆ–è€…åº«å­˜ç‚ºè² çš„
      if (item.safety > 0 || item.current < 0) {
        hasData = true;
        let statusHtml = "";
        if (item.current < 0) {
          statusHtml = `<span class="status-badge status-low">åº«å­˜ç•°å¸¸ (è² æ•¸)</span>`;
        } else if (item.current < item.safety) {
          statusHtml = `<span class="status-badge status-low">åº«å­˜å‘Šæ€¥ (ä½æ–¼ ${item.safety})</span>`;
        } else if (item.current < item.safety * 1.5) {
          statusHtml = `<span class="status-badge status-warn">åº«å­˜åä½</span>`;
        } else {
          statusHtml = `<span class="status-badge status-ok">åº«å­˜å……è¶³</span>`;
        }

        container.innerHTML += `
          <div class="record-li" style="border-left-color: ${item.current < item.safety ? '#d64545' : '#2ecc71'};">
            <strong>${item.name}</strong> (${pNo})<br>
            ç›®å‰åº«å­˜: ${item.current} / å®‰å…¨å­˜é‡: ${item.safety}<br>
            <div style="margin-top:8px;">${statusHtml}</div>
          </div>
        `;
      }
    });

    if(!hasData) {
      container.innerHTML = "<p style='text-align:center; color:#666;'>ç›®å‰æ²’æœ‰è¨­å®šå®‰å…¨å­˜é‡çš„é …ç›®ï¼Œæˆ–åº«å­˜çš†æ­£å¸¸ã€‚<br>è«‹åœ¨ä¸Šæ”¾è¨­å®šé è­¦å€¼ã€‚</p>";
    }
  }

  // --- ç°½åæª”åˆ‡æ› ---
  function toggleSignature(el) {
    const span = document.getElementById('sigName');
    span.hidden = !span.hidden;
  }

</script>
</body>
</html>
